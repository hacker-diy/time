<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Time Trick Lock Screen</title>

  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <style>
    :root {
      color-scheme: dark;
      --lock-offset-x: 0px;
      --lock-offset-y: 0px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #000;
      overflow: hidden;
      touch-action: manipulation;
    }

    .screen {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 10%, #272735 0, #050509 55%, #000 100%);
      color: #fff;
      overflow: hidden;
      padding-top: calc(env(safe-area-inset-top, 0) + 4px);
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* –ë–µ–ª–∞—è –º–∞—Å–∫–∞ –≤ –∑–æ–Ω–µ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ */
    .status-mask {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: calc(env(safe-area-inset-top, 24px));
      background: #ffffff;
      z-index: 4;
      pointer-events: none;
    }

    .wallpaper {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 0;
    }

    .screen::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.9) 0, rgba(255,255,255,0) 60%),
        radial-gradient(circle, rgba(255,255,255,0.8) 0, rgba(255,255,255,0) 60%),
        radial-gradient(circle, rgba(255,255,255,0.7) 0, rgba(255,255,255,0) 60%),
        radial-gradient(circle, rgba(255,255,255,0.6) 0, rgba(255,255,255,0) 60%),
        radial-gradient(circle, rgba(255,255,255,0.7) 0, rgba(255,255,255,0) 60%);
      background-position:
        10% 30%,
        80% 18%,
        90% 55%,
        25% 80%,
        70% 90%;
      background-size: 2px 2px, 2px 2px, 2px 2px, 3px 3px, 2px 2px;
      background-repeat: no-repeat;
      pointer-events: none;
      z-index: 1;
      opacity: 0.8;
    }

    .planet {
      position: absolute;
      left: 50%;
      top: 33vh;
      width: 80vw;
      max-width: 700px;
      aspect-ratio: 1 / 1;
      transform: translateX(-50%);
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 20%, #ffcf8c 0, rgba(255,207,140,0) 50%),
        radial-gradient(circle at 20% 80%, #7f3f9b 0, rgba(127,63,155,0) 55%),
        radial-gradient(circle at 75% 60%, #62308b 0, rgba(98,48,139,0) 50%),
        radial-gradient(circle at 40% 50%, #b6552a 0, #8c3e26 55%, #4d2137 100%);
      box-shadow:
        0 0 40px rgba(0,0,0,0.9),
        0 0 120px rgba(0,0,0,0.9);
      z-index: 2;
      overflow: hidden;
    }

    .lock-info {
      position: absolute;
      top: 10.5vh;
      left: 50%;
      transform: translate(calc(-50% + var(--lock-offset-x)), var(--lock-offset-y));
      text-align: center;
      z-index: 3;
      touch-action: none;
    }

    .lock-info .date {
      font-size: 1.05rem;
      font-weight: 500;
      margin-bottom: 0.35rem;
    }

    .lock-info .time {
      font-size: clamp(4.4rem, 13vw, 5.4rem);
      font-weight: 600;
      letter-spacing: 0.05em;
      line-height: 1;
      margin-bottom: 1.1rem;
      display: inline-block;
      transform-origin: center;
    }

    .weather {
      position: absolute;
      top: 22vh;
      left: 1.5rem;
      text-align: left;
      z-index: 3;
    }

    .weather .temp {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 1rem;
      font-weight: 500;
    }

    .weather .temp-icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    .weather .conditions {
      font-size: 0.9rem;
      margin-top: 0.1rem;
    }

    .weather .range {
      font-size: 0.8rem;
      margin-top: 0.1rem;
      opacity: 0.8;
    }

    .bottom-controls {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 8vh;
      padding: 0 4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 3;
    }

    .circle-btn {
      width: 3.4rem;
      height: 3.4rem;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.25);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), rgba(0,0,0,0.9));
      box-shadow:
        0 0 0 0.5px rgba(255,255,255,0.15),
        0 10px 20px rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      position: relative;
      overflow: hidden;
    }

    .circle-btn::before {
      content: "";
      position: absolute;
      width: 74%;
      height: 74%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.35), rgba(255,255,255,0.02));
      opacity: 0.7;
      pointer-events: none;
    }

    .circle-btn svg {
      width: 1.6rem;
      height: 1.6rem;
      fill: #fff;
      pointer-events: none;
      position: relative;
      z-index: 1;
    }

    .home-indicator {
      position: absolute;
      left: 50%;
      bottom: 0.7rem;
      transform: translateX(-50%);
      width: 6rem;
      height: 0.3rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      z-index: 3;
    }

    .black-screen {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 10;
    }

    .settings {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 20;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .settings-panel {
      width: 100%;
      max-width: 480px;
      margin: auto;
      background: #000;
      border-radius: 0;
      padding: calc(env(safe-area-inset-top, 0) + 1rem) 1.7rem 2rem;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      color: #fff;
    }

    .settings-reset-btn {
      display: block;
      margin: 0 auto 0.7rem auto;
      background: none;
      border: 1px solid #444;
      color: #bbb;
      font-size: 0.55rem;
      padding: 0.12rem 0.35rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .settings-panel h2 {
      font-size: 1.3rem;
      margin-bottom: 0.8rem;
      text-align: center;
    }

    .settings-panel label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    .settings-panel input[type="number"],
    .settings-panel input[type="file"] {
      width: 100%;
      margin-top: 0.25rem;
      margin-bottom: 0.4rem;
      padding: 0.4rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid #333;
      background: #181818;
      color: #fff;
      font-size: 0.95rem;
    }

    .settings-panel input[type="file"] {
      padding: 0.3rem 0.3rem;
    }

    .settings-panel button {
      margin-top: 0.7rem;
      width: 100%;
      padding: 0.6rem 0.8rem;
      border-radius: 999px;
      border: none;
      background: #ffffff;
      color: #000;
      font-weight: 600;
      font-size: 1rem;
    }

    .settings-panel small {
      display: block;
      margin-top: 0.4rem;
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .clock-edit-panel {
      position: absolute;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 420px;
      background: rgba(0,0,0,0.8);
      border-radius: 12px;
      padding: 0.5rem 0.8rem 0.6rem;
      z-index: 4;
      font-size: 0.7rem;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .clock-edit-panel label {
      display: flex;
      flex-direction: column;
      margin-bottom: 0.35rem;
    }

    .clock-edit-panel input[type="range"] {
      width: 100%;
    }

    .clock-edit-save-btn {
      margin-top: 0.25rem;
      width: 100%;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      border: none;
      background: #ffffff;
      color: #000;
      font-weight: 600;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="screen">
    <!-- –ë–µ–ª–∞—è –ø–æ–ª–æ—Å–∞-–º–∞—Å–∫–∞ –≤–≤–µ—Ä—Ö—É -->
    <div class="status-mask"></div>

    <div class="wallpaper" id="wallpaper"></div>
    <div class="planet" id="planet"></div>

    <div class="lock-info">
      <div class="date" id="lock-date">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <div class="time" id="lock-time">--:--</div>
    </div>

    <div class="weather">
      <div class="temp">
        <span class="temp-icon" id="weather-icon">‚òÅÔ∏è</span>
        <span id="weather-temp">--¬∞</span>
      </div>
      <div class="conditions" id="weather-cond">–ü–æ–≥–æ–¥–∞</div>
      <div class="range" id="weather-range">‚Üì --¬∞ ‚Üë --¬∞</div>
    </div>

    <div class="bottom-controls">
      <button class="circle-btn flashlight" aria-label="–§–æ–Ω–∞—Ä–∏–∫">
        <svg viewBox="0 0 24 24">
          <path d="M9 2h6v2H9V2zm1 4h4l1 2v2l-1 2v8a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-8l-1-2V8l1-2zM11 13v7h2v-7h-2z"/>
        </svg>
      </button>

      <button class="circle-btn camera" aria-label="–ö–∞–º–µ—Ä–∞" id="camera-btn">
        <svg viewBox="0 0 24 24">
          <path d="M9 3h6l2 3h3a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3zm3 6a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/>
        </svg>
      </button>
    </div>

    <div class="home-indicator"></div>

    <div class="clock-edit-panel" id="clock-edit-panel" style="display: none;">
      <label>
        –†–∞–∑–º–µ—Ä –≤—Ä–µ–º–µ–Ω–∏
        <input type="range" id="clock-size" min="0.5" max="1.8" step="0.05" value="1">
      </label>
      <label>
        –¢–æ–ª—â–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏
        <input type="range" id="clock-weight" min="300" max="900" step="50" value="600">
      </label>
      <button class="clock-edit-save-btn" id="clock-edit-save" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="black-screen" id="black-screen" style="display: none;"></div>

    <div class="settings" id="settings-modal" style="display: none;">
      <div class="settings-panel">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä—é–∫–∞</h2>
        <button class="settings-reset-btn" id="settings-reset" type="button">Reset</button>

        <label>
          –°–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–º–∏–Ω—É—Ç—ã)
          <input type="number" id="offset-minutes" value="5" step="1">
        </label>

        <label>
          –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–º–æ—Ç–∫–æ–π (—Å–µ–∫—É–Ω–¥—ã)
          <input type="number" id="rewind-delay" value="5" step="1">
        </label>

        <label>
          –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–º–æ—Ç–∫–∏ (x, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
          <input type="number" id="rewind-speed" value="100" step="1" min="1" max="200">
        </label>

        <label>
          –°–≤–æ—è –∑–∞—Å—Ç–∞–≤–∫–∞
          <input type="file" id="wallpaper-input" accept="image/*">
        </label>

        <small>–ü–æ–¥—Å–∫–∞–∑–∫–∞: —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç–æ –º–µ–Ω—é –Ω–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–∏, –±—ã—Å—Ç—Ä–æ –Ω–∞–∂–º–∏ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∫–∞–º–µ—Ä—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.</small>

        <button id="settings-done" type="button">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const timeEl = document.getElementById("lock-time");
      const dateEl = document.getElementById("lock-date");

      const blackScreen = document.getElementById("black-screen");
      const cameraBtn = document.getElementById("camera-btn");
      const settingsModal = document.getElementById("settings-modal");
      const offsetInput = document.getElementById("offset-minutes");
      const delayInput = document.getElementById("rewind-delay");
      const rewindSpeedInput = document.getElementById("rewind-speed");
      const settingsDoneBtn = document.getElementById("settings-done");
      const settingsResetBtn = document.getElementById("settings-reset");

      const wallpaperInput = document.getElementById("wallpaper-input");
      const wallpaperDiv = document.getElementById("wallpaper");
      const planetDiv = document.getElementById("planet");

      const tempEl = document.getElementById("weather-temp");
      const condEl = document.getElementById("weather-cond");
      const rangeEl = document.getElementById("weather-range");
      const iconEl = document.getElementById("weather-icon");

      const flashlightBtn = document.querySelector(".circle-btn.flashlight");
      const lockInfo = document.querySelector(".lock-info");
      const clockEditPanel = document.getElementById("clock-edit-panel");
      const sizeSlider = document.getElementById("clock-size");
      const weightSlider = document.getElementById("clock-weight");
      const clockEditSaveBtn = document.getElementById("clock-edit-save");

      const rootStyle = document.documentElement.style;

      const DEFAULT_OFFSET_MIN = 5;
      const DEFAULT_DELAY_SEC = 5;
      const DEFAULT_REWIND_SPEED = 100;

      const STORAGE_KEYS = {
        offsetMin: "tt_offset_min",
        delaySec: "tt_delay_sec",
        speed: "tt_rewind_speed",
        lockOffsetX: "tt_lock_offset_x",
        lockOffsetY: "tt_lock_offset_y",
        clockScale: "tt_clock_scale",
        clockWeight: "tt_clock_weight"
      };

      let mode = "normal";

      let timeOffsetMs = DEFAULT_OFFSET_MIN * 60 * 1000;
      let rewindDelayMs = DEFAULT_DELAY_SEC * 1000;
      let rewindSpeed = DEFAULT_REWIND_SPEED;

      let realAtTrickStart = null;
      let realAtRewindStart = null;
      let fakeAtRewindStart = null;

      let editMode = false;

      function renderTime(dateObj) {
        const hours = String(dateObj.getHours()).padStart(2, "0");
        const minutes = String(dateObj.getMinutes()).padStart(2, "0");
        timeEl.textContent = hours + ":" + minutes;

        const options = { weekday: "long", day: "numeric", month: "long" };
        let dateStr = dateObj.toLocaleDateString("ru-RU", options);
        dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        dateEl.textContent = dateStr;
      }

      function clockTick() {
        const now = new Date();

        if (mode === "normal" || mode === "trick_wait_tap") {
          renderTime(now);
        } else if (mode === "trick_fixed") {
          const fakeTime = new Date(realAtTrickStart.getTime() + timeOffsetMs);
          renderTime(fakeTime);

          if (now - realAtTrickStart >= rewindDelayMs) {
            mode = "trick_rewind";
            realAtRewindStart = now;
            fakeAtRewindStart = fakeTime;
          }
        } else if (mode === "trick_rewind") {
          const elapsedReal = now - realAtRewindStart;
          const deltaMs = elapsedReal * rewindSpeed;
          let fakeTime = new Date(fakeAtRewindStart.getTime() - deltaMs);

          if (fakeTime <= now) {
            fakeTime = now;
            mode = "normal";
          }

          renderTime(fakeTime);
        }

        requestAnimationFrame(clockTick);
      }

      requestAnimationFrame(clockTick);

      function startTrickAfterTap() {
        if (mode !== "trick_wait_tap") return;
        blackScreen.style.display = "none";
        realAtTrickStart = new Date();
        mode = "trick_fixed";
      }

      blackScreen.addEventListener("click", startTrickAfterTap);
      blackScreen.addEventListener("touchstart", (e) => {
        e.preventDefault();
        startTrickAfterTap();
      }, { passive: false });

      function saveTrickSettings() {
        try {
          localStorage.setItem(STORAGE_KEYS.offsetMin, String(offsetInput.value));
          localStorage.setItem(STORAGE_KEYS.delaySec, String(delayInput.value));
          localStorage.setItem(STORAGE_KEYS.speed, String(rewindSpeedInput.value));
        } catch (e) {}
      }

      function loadTrickSettings() {
        try {
          const storedOffset = localStorage.getItem(STORAGE_KEYS.offsetMin);
          const storedDelay = localStorage.getItem(STORAGE_KEYS.delaySec);
          const storedSpeed = localStorage.getItem(STORAGE_KEYS.speed);

          const offsetMin = storedOffset !== null ? parseFloat(storedOffset) : DEFAULT_OFFSET_MIN;
          const delaySec = storedDelay !== null ? parseFloat(storedDelay) : DEFAULT_DELAY_SEC;
          const speedVal = storedSpeed !== null ? parseFloat(storedSpeed) : DEFAULT_REWIND_SPEED;

          offsetInput.value = String(offsetMin);
          delayInput.value = String(delaySec);
          rewindSpeedInput.value = String(speedVal);

          timeOffsetMs = offsetMin * 60 * 1000;
          rewindDelayMs = delaySec * 1000;
          rewindSpeed = speedVal;
        } catch (e) {}
      }

      loadTrickSettings();

      let tapCount = 0;
      let tapTimer = null;

      cameraBtn.addEventListener("click", () => {
        tapCount++;
        if (tapCount === 1) {
          tapTimer = setTimeout(() => {
            tapCount = 0;
          }, 1500);
        }
        if (tapCount >= 5) {
          clearTimeout(tapTimer);
          tapCount = 0;
          settingsModal.style.display = "flex";
        }
      });

      settingsDoneBtn.addEventListener("click", () => {
        const offsetMin = parseFloat(offsetInput.value) || 0;
        const delaySec = parseFloat(delayInput.value) || 0;
        let speed = parseFloat(rewindSpeedInput.value) || DEFAULT_REWIND_SPEED;
        if (speed < 1) speed = 1;
        if (speed > 200) speed = 200;

        timeOffsetMs = offsetMin * 60 * 1000;
        rewindDelayMs = delaySec * 1000;
        rewindSpeed = speed;

        saveTrickSettings();

        settingsModal.style.display = "none";
        blackScreen.style.display = "block";
        mode = "trick_wait_tap";
      });

      settingsResetBtn.addEventListener("click", () => {
        offsetInput.value = String(DEFAULT_OFFSET_MIN);
        delayInput.value = String(DEFAULT_DELAY_SEC);
        rewindSpeedInput.value = String(DEFAULT_REWIND_SPEED);

        timeOffsetMs = DEFAULT_OFFSET_MIN * 60 * 1000;
        rewindDelayMs = DEFAULT_DELAY_SEC * 1000;
        rewindSpeed = DEFAULT_REWIND_SPEED;

        wallpaperDiv.style.backgroundImage = "";
        if (planetDiv) planetDiv.style.display = "";

        rootStyle.setProperty("--lock-offset-x", "0px");
        rootStyle.setProperty("--lock-offset-y", "0px");
        sizeSlider.value = "1";
        weightSlider.value = "600";
        timeEl.style.transform = "scale(1)";
        timeEl.style.fontWeight = "600";

        try {
          Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
        } catch (e) {}

        blackScreen.style.display = "none";
        settingsModal.style.display = "none";
        setEditMode(false);
        mode = "normal";
      });

      wallpaperInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          wallpaperDiv.style.backgroundImage = "url('" + ev.target.result + "')";
          if (planetDiv) planetDiv.style.display = "none";
        };
        reader.readAsDataURL(file);
      });

      function mapWeatherCodeRu(code) {
        if (code === 0) { iconEl.textContent = "‚òÄÔ∏è"; return "–Ø—Å–Ω–æ"; }
        if ([1,2,3].includes(code)) { iconEl.textContent = "‚õÖ"; return "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å"; }
        if ([45,48].includes(code)) { iconEl.textContent = "üå´"; return "–¢—É–º–∞–Ω"; }
        if ([51,53,55].includes(code)) { iconEl.textContent = "üå¶"; return "–ú–æ—Ä–æ—Å—å"; }
        if ([61,63,65,80,81,82].includes(code)) { iconEl.textContent = "üåß"; return "–î–æ–∂–¥—å"; }
        if ([71,73,75,77,85,86].includes(code)) { iconEl.textContent = "‚ùÑÔ∏è"; return "–°–Ω–µ–≥"; }
        if ([95,96,99].includes(code)) { iconEl.textContent = "‚õà"; return "–ì—Ä–æ–∑–∞"; }
        iconEl.textContent = "‚òÅÔ∏è";
        return "–û–±–ª–∞—á–Ω–æ";
      }

      function initWeather() {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(async (pos) => {
          try {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const url =
              "https://api.open-meteo.com/v1/forecast?latitude=" + lat +
              "&longitude=" + lon +
              "&current_weather=true&daily=temperature_2m_max,temperature_2m_min&timezone=auto";

            const res = await fetch(url);
            const data = await res.json();
            if (!data.current_weather) return;

            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            tempEl.textContent = temp + "¬∞";
            condEl.textContent = mapWeatherCodeRu(code);

            const daily = data.daily;
            if (daily && daily.temperature_2m_min && daily.temperature_2m_max) {
              const min = Math.round(daily.temperature_2m_min[0]);
              const max = Math.round(daily.temperature_2m_max[0]);
              rangeEl.textContent = "‚Üì " + min + "¬∞ ‚Üë " + max + "¬∞";
            }
          } catch (e) {
            console.error("Weather error:", e);
          }
        }, () => {});
      }

      initWeather();

      function setEditMode(enabled) {
        editMode = enabled;
        clockEditPanel.style.display = enabled ? "block" : "none";
      }

      function saveClockLayout() {
        try {
          const x = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--lock-offset-x")) || 0;
          const y = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--lock-offset-y")) || 0;
          const scale = parseFloat(sizeSlider.value) || 1;
          const weight = parseInt(weightSlider.value) || 600;

          localStorage.setItem(STORAGE_KEYS.lockOffsetX, String(x));
          localStorage.setItem(STORAGE_KEYS.lockOffsetY, String(y));
          localStorage.setItem(STORAGE_KEYS.clockScale, String(scale));
          localStorage.setItem(STORAGE_KEYS.clockWeight, String(weight));
        } catch (e) {}
      }

      function loadClockLayout() {
        try {
          const x = localStorage.getItem(STORAGE_KEYS.lockOffsetX);
          const y = localStorage.getItem(STORAGE_KEYS.lockOffsetY);
          const scale = localStorage.getItem(STORAGE_KEYS.clockScale);
          const weight = localStorage.getItem(STORAGE_KEYS.clockWeight);

          if (x !== null) {
            rootStyle.setProperty("--lock-offset-x", x + "px");
          }
          if (y !== null) {
            rootStyle.setProperty("--lock-offset-y", y + "px");
          }
          if (scale !== null) {
            sizeSlider.value = scale;
            timeEl.style.transform = "scale(" + scale + ")";
          }
          if (weight !== null) {
            weightSlider.value = weight;
            timeEl.style.fontWeight = String(weight);
          }
        } catch (e) {}
      }

      loadClockLayout();

      let flashTapCount = 0;
      let flashTapTimer = null;

      flashlightBtn.addEventListener("click", () => {
        flashTapCount++;
        if (flashTapCount === 1) {
          flashTapTimer = setTimeout(() => {
            flashTapCount = 0;
          }, 1500);
        }
        if (flashTapCount >= 5) {
          clearTimeout(flashTapTimer);
          flashTapCount = 0;
          setEditMode(!editMode);
        }
      });

      let dragging = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let baseOffsetX = 0;
      let baseOffsetY = 0;

      function getOffsetVar(name) {
        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        if (!v) return 0;
        return parseFloat(v);
      }

      lockInfo.addEventListener("pointerdown", (e) => {
        if (!editMode) return;
        dragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        baseOffsetX = getOffsetVar("--lock-offset-x");
        baseOffsetY = getOffsetVar("--lock-offset-y");
        lockInfo.setPointerCapture(e.pointerId);
      });

      lockInfo.addEventListener("pointermove", (e) => {
        if (!dragging) return;
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        const newX = baseOffsetX + dx;
        const newY = baseOffsetY + dy;
        rootStyle.setProperty("--lock-offset-x", newX + "px");
        rootStyle.setProperty("--lock-offset-y", newY + "px");
      });

      lockInfo.addEventListener("pointerup", () => {
        dragging = false;
      });

      lockInfo.addEventListener("pointercancel", () => {
        dragging = false;
      });

      sizeSlider.addEventListener("input", (e) => {
        const s = parseFloat(e.target.value) || 1;
        timeEl.style.transform = "scale(" + s + ")";
      });

      weightSlider.addEventListener("input", (e) => {
        const w = parseInt(e.target.value) || 600;
        timeEl.style.fontWeight = String(w);
      });

      clockEditSaveBtn.addEventListener("click", () => {
        saveClockLayout();
        setEditMode(false);
      });
    });
  </script>
</body>
</html>
